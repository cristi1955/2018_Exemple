(function(){define(["external/underscore","external/react","external/react-dom","external/reflux","modules/core/exception","modules/constants/comments_panel","modules/clean/analytics","modules/clean/comments/components/file_preview_annotations","modules/clean/comments/components/file_preview_overlay","modules/clean/comments/components/switch_revision_ui_container","modules/clean/comments/events","modules/clean/comments/flux","modules/clean/comments/more_option_helpers","modules/clean/comments/store","modules/clean/comments/url_handler","modules/clean/comments/utils","external/eventemitter3","modules/clean/file_activity/clients/file_activity_data_source","modules/clean/react/file_comments/file_comments_pane","modules/clean/react/file_comments/shared_link_signup_modals","modules/clean/react/file_viewer/file_viewer_interface_controller","modules/clean/react/file_viewer/more_dropdown/more_option_registry"],function(e,t,n,i,o,r,s,a,l,u,c,m,p,d,h,v,C,w,f,y,g,F){var R,_,I,P,S,A,O,assert,M;return assert=o.assert,I=s.CommentsVortexLogger,O=u.SwitchRevisionUIContainer,_=c.CommentsEventsMixin,P=f.FileCommentsPaneClass,S=g.FileViewerInterfaceController,M=F.moreOptionRegistry,R="annotation-overlay",A="switch-revision-container",t.createClass({displayName:"FileCommentsPaneContainer",mixins:[m.sync(d),_],propTypes:{actorId:t.PropTypes.number,context:t.PropTypes.number,contextData:t.PropTypes.string,currentFile:t.PropTypes.object,hideCommentsOverride:t.PropTypes.bool,isDemoMode:t.PropTypes.bool,oref:t.PropTypes.string,previewSelector:t.PropTypes.string.isRequired,shouldInitiallyFocusInput:t.PropTypes.bool,initialCommentsCount:t.PropTypes.number,actionCreators:t.PropTypes.object.isRequired,showToggleButton:t.PropTypes.bool},componentWillMount:function(){if(this.initAnnotationReadyQueue(),this.props.isDemoMode||this.initSignUpModalIfNecessary(),this.onCommentsEvent("preview-and-comments-ready",this.onPreviewAndCommentsReady),this.onCommentsEvent("revision-did-change",this.onViewingRevisionDidChange),this.onCommentsEvent("reveal-annotation",this.onRevealAnnotation),!this.props.isDemoMode)return this.onCommentsEvent("show-sign-up-modal",this.onShowSignUpModal)},componentDidMount:function(){if(null!=this.props.context&&null!=this.props.contextData&&this.onFileViewerOpen(this.props),this.props.actionCreators.showOnboardingIfNecessary(),this.updateCommentsMoreOptionGroup(),this.renderSwitchRevisionUI(),this.props.isDemoMode)return d.demoLoadData()},componentWillReceiveProps:function(e){if(this.state.viewing.contextData!==e.contextData)return this.state.viewing.contextData?this.onFileViewerFlip(e):this.onFileViewerOpen(e)},componentDidUpdate:function(){return this.updateCommentsMoreOptionGroup()},componentWillUnmount:function(){return this.clearAnnotationReadyQueue(),this.removeCommentsMoreOptionGroup(),this.unmountSwitchRevisionUI(),this.onFileViewerClose()},_onViewingFileWillChange:function(e){var t;if(I.log("load-comments-attempt"),this.isAnnotationReady=!1,this.unmountFilePreviewComponents(),this.props.actionCreators.startViewingComments({actorId:e.actorId,context:e.context,contextData:e.contextData,oref:e.oref,file:e.currentFile,previewSelector:e.previewSelector,showCommentsOverride:e.shouldInitiallyFocusInput?e.shouldInitiallyFocusInput:null,showTutorialOverride:!!e.isDemoMode||null}),this.asyncMountFilePreviewComponents(),r.SHOW_REVISIONS&&null!=(null!=(t=e.currentFile)?t.fq_path:void 0))return this.props.actionCreators.fetchRevisions(e.currentFile.fq_path)},onFileViewerOpen:function(e){return this._onViewingFileWillChange(e)},onFileViewerFlip:function(e){return this._onViewingFileWillChange(e),h.onFileViewerFlip()},onFileViewerClose:function(){return this.isAnnotationReady=!1,this.unmountFilePreviewComponents(),this.props.actionCreators.stopViewingComments(),h.onFileViewerClose()},onViewingRevisionDidChange:function(){return this.isAnnotationReady=!1,this.unmountFilePreviewComponents(),this.asyncMountFilePreviewComponents()},onPreviewAndCommentsReady:function(){return assert(null!=this.fileViewerInterfaceController,"File viewer interface controller is not initialized"),this.unmountFilePreviewAnnotations(),this.unmountFilePreviewOverlay(),this.mountFilePreviewAnnotations(),this.mountFilePreviewOverlay(),this.isAnnotationReady=!0,this.processAnnotationReadyQueue(),h.onPreviewAndCommentsReady(this.props.actionCreators)},renderSwitchRevisionUI:function(){return n.render(t.createElement(O,{actionCreators:this.props.actionCreators}),this.getOrCreateSwitchRevisionUIContainerNode())},unmountSwitchRevisionUI:function(){var e;if(e=this.getSwitchRevisionUIContainerNode(),null!=e)return n.unmountComponentAtNode(e)},getSwitchRevisionUIContainerNode:function(){return document.getElementById(A)},getOrCreateSwitchRevisionUIContainerNode:function(){var e;return e=this.getSwitchRevisionUIContainerNode(),null==e&&(e=document.createElement("div"),e.id=A,document.body.appendChild(e)),e},asyncMountFilePreviewComponents:function(){return this.createFileViewerInterfaceController()},unmountFilePreviewComponents:function(){var e;return this.unmountFilePreviewAnnotations(),this.unmountFilePreviewOverlay(),this.destroyFileViewerInterfaceController(),"function"==typeof(e=this.state).unsubscribePreviewAndCommentsReady?e.unsubscribePreviewAndCommentsReady():void 0},mountFilePreviewAnnotations:function(){return this.filePreviewAnnotations=a.create(this.props.actionCreators),this.filePreviewAnnotations.mount(this.fileViewerInterfaceController)},unmountFilePreviewAnnotations:function(){var e;if(null!=(e=this.filePreviewAnnotations)?e.isMounted():void 0)return this.filePreviewAnnotations.unmount()},getOrCreateFilePreviewOverlayContainer:function(e){var t;return t=document.getElementById(R),t||(t=document.createElement("div"),t.id=R,e.appendChild(t)),t},mountFilePreviewOverlay:function(){var e,i;return(i=document.querySelector(this.props.previewSelector))?(this.overlayContainerNode=this.getOrCreateFilePreviewOverlayContainer(i),e=t.createElement(l,{previewContainer:i,actionCreators:this.props.actionCreators,isDemoMode:this.props.isDemoMode}),n.render(e,this.overlayContainerNode)):void console.error("Preview container does not exist!")},unmountFilePreviewOverlay:function(){if(this.overlayContainerNode)return n.unmountComponentAtNode(this.overlayContainerNode)},createFileViewerInterfaceController:function(){var e,t,n;return n=d.state.viewing,e=n.context,t=n.file,this.fileViewerInterfaceController=new S(v.getPreviewType(e,t.preview_type),this.props.previewSelector),this.fileViewerInterfaceController.addListener("page-rendered",(function(e){return function(t){var n;if(n=null!=(null!=t?t.page:void 0),!n||n&&!e.state.isPreviewReady&&!(null!=t?t.isFullscreen:void 0))return e.props.actionCreators.notifyPreviewReady()}})(this)),this.fileViewerInterfaceController.dispatchEvent("file-feedback-ui-ready")},destroyFileViewerInterfaceController:function(){var e;return null!=(e=this.fileViewerInterfaceController)?e.destroy():void 0},initAnnotationReadyQueue:function(){return this.annotationReadyQueue=new C},clearAnnotationReadyQueue:function(){return this.annotationReadyQueue.removeAllListeners()},processAnnotationReadyQueue:function(){return this.annotationReadyQueue.emit("reveal-annotation")},onRevealAnnotation:function(t){return this.isAnnotationReady?this.doRevealAnnotation(t):(this.annotationReadyQueue.removeAllListeners("reveal-annotation"),this.annotationReadyQueue.once("reveal-annotation",e.partial(this.doRevealAnnotation,t)))},doRevealAnnotation:function(e){return this.fileViewerInterfaceController.dispatchEvent("scroll-to-annotation",e)},onShowSignUpModal:function(e){var t,n;if(t=e.fileActivityKey,n=e.variant,!this.props.isDemoMode)return assert(null!=this.signUpModal,"Sign-up modal not initialized!"),this.signUpModal.set_activity_key(t),this.signUpModal.show_sign_in_modal(n)},initSignUpModalIfNecessary:function(){var e;if(!v.getActivityUser(this.state.actorId).is_signed_in)return e=y.CommentsSharedLinkSignupModals,this.signUpModal=new e},_getRelevantStoreState:function(){return{isFileActivityReady:d.isFileActivityReady(),isCommentingEnabled:d.isCommentingEnabled(),isUserSubscribed:d.isUserSubscribed(this.props.actorId),showResolvedComments:d.state.showResolvedComments,canEnableComments:d.canEnableComments()&&!this.props.isDemoMode}},updateCommentsMoreOptionGroup:function(){var e;return e=p.generateMoreOptionGroup(this._getRelevantStoreState(),this.props,this.props.actionCreators),null==e?this.removeCommentsMoreOptionGroup():null==this._moreOptionGroup?M.addOption(e):M.replaceOption(this._moreOptionGroup,e),this._moreOptionGroup=e},removeCommentsMoreOptionGroup:function(){if(null!=this._moreOptionGroup)return M.removeOption(this._moreOptionGroup)},getInitialCommentsCount:function(){var e,t;return null!=this.props.initialCommentsCount?this.props.initialCommentsCount:null!=(null!=(e=this.props.currentFile)?e.unresolved_comment_count:void 0)?null!=(t=this.props.currentFile)?t.unresolved_comment_count:void 0:null},render:function(){var e,n;return e=this.getInitialCommentsCount(),n=null!=this.props.hideCommentsOverride?this.props.hideCommentsOverride:d.areCommentsHidden(),t.createElement(P,{ref:"fileCommentsPane",feedbackId:"file-comments",activity:this.state.activity,showLoadingSpinner:0!==e&&this.state.showLoadingSpinner,context:this.state.viewing.context,contextData:this.state.viewing.contextData,userId:this.state.actorId,file:this.props.currentFile,oref:this.state.oref,isPreviewReady:this.state.isPreviewReady,showResolvedComments:this.state.showResolvedComments,showTutorial:d.isTutorialShown(),currentTutorialStep:this.state.currentTutorialStep,revisions:this.state.revisions,isCommentsHidden:n,enableImport:!1,previewSelector:this.props.previewSelector,shouldAutoLinkify:!0,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,shouldUseSimpleModals:!1,showButtonColor:"white",initialCommentsCount:e,isUserSubscribed:d.isUserSubscribed(this.state.actorId),isRegionCreationEnabled:this.state.regionCreationEnabled,actionCreators:this.props.actionCreators,isDemoMode:this.props.isDemoMode,isCommentingEnabled:d.isCommentingEnabled(),showToggleButton:this.props.showToggleButton})}})})}).call(this);
//# sourceMappingURL=file_comments_pane_container.min.js-vfl4ouFSJ.map